name: Generate Index

permissions:
  contents: write

on:
  push:
    branches:
      - main
    paths:
      - "scripts/**"
      - "md/**"
  # æ’é™¤ç”±åŒæ­¥è„šæœ¬è§¦å‘çš„æäº¤ï¼ˆé¿å…å¾ªç¯ï¼‰
  # åŒæ­¥è„šæœ¬ä½¿ç”¨ [skip ci] æ ‡è®°ï¼Œä¸ä¼šè§¦å‘æ­¤å·¥ä½œæµ

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œé¿å…æ¨é€å†²çª

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          echo "No external dependencies required"

      - name: Parse MD files to JSON
        # æ³¨æ„ï¼šall-books.json é€šå¸¸å·²ç”±åŒæ­¥è„šæœ¬ç”Ÿæˆ
        # è¿™é‡Œç¡®ä¿all-books.jsonå­˜åœ¨ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™ç”Ÿæˆï¼‰
        run: |
          if [ ! -f "docs/all-books.json" ]; then
            echo "âš ï¸  all-books.json ä¸å­˜åœ¨ï¼Œç”Ÿæˆä¸­..."
            python scripts/parse_md_to_json.py
          else
            echo "âœ… all-books.json å·²å­˜åœ¨ï¼ˆå¯èƒ½ç”±åŒæ­¥è„šæœ¬ç”Ÿæˆï¼‰ï¼Œè·³è¿‡ç”Ÿæˆ"
          fi

      - name: Generate index.html
        run: |
          python scripts/generate_index.py

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/index.html docs/books.json docs/all-books.json docs/parse-stats.json docs/search.js
          git rm docs/index.md 2>/dev/null || true
          git commit -m "auto: update index and search data" || echo "No changes"
          
          # åœ¨æ¨é€å‰å…ˆæ‹‰å–è¿œç¨‹æ›´æ”¹ï¼ˆé¿å…æ¨é€å†²çªï¼‰
          echo "ğŸ“¥ æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
          git fetch origin main
          git pull origin main --rebase || git pull origin main --no-rebase || true
          
          # æ¨é€æ›´æ”¹ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
          max_retries=3
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if git push origin main; then
              echo "âœ… æ¨é€æˆåŠŸ"
              break
            else
              retry_count=$((retry_count + 1))
              echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œé‡è¯• $retry_count/$max_retries..."
              if [ $retry_count -lt $max_retries ]; then
                # é‡æ–°æ‹‰å–å¹¶åˆå¹¶
                git fetch origin main
                git rebase origin/main || git merge origin/main || true
                sleep 2
              else
                echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                exit 1
              fi
            fi
          done
